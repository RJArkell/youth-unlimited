const BASE_URL="https://yugta.ca";const MAPBOX_STYLE_URL="mapbox://styles/yugta/cklr089ge01d617pk1r3ve3gu";const MAPBOX_STYLE_URL_V2="mapbox://styles/yugta/ckmm01zve0u5v17nrbb15c8v0";const MAPBOX_ACCESS_TOKEN="pk.eyJ1IjoieXVndGEiLCJhIjoiY2trMnJqcm0xMGRwZzJxbnVxN2ViNXE5MiJ9.EGJpk3Lx5gcU4PFonjNqWQ";var catchments,teams,gta,areas;const init=async()=>{await Promise.all([d3.csv("./data/catchments.csv"),d3.csv("./data/teams.csv"),d3.json("./data/gta.json"),d3.json("./data/areas.json")]).then(([catchments_json,teams_json,gta_json,areas_json])=>{catchments=catchments_json;teams=teams_json;gta=gta_json;areas=areas_json;catchments.forEach(d=>{let f=areas.features.find(f=>f.properties.catchment==d.id);if(!f){console.log("feature not found : "+d.id)}else{f.properties=Object.assign(f.properties,d);f.properties.opacity=+f.properties.opacity;f.properties.aggregation_level=+f.properties.aggregation_level;f.properties.critical_care=+f.properties.critical_care;f.properties.community_outreach=+f.properties.community_outreach;f.properties.innovative_centres=+f.properties.innovative_centres;f.properties.leadership_development=+f.properties.leadership_development;f.properties.marketplace=+f.properties.marketplace;f.properties.trips_camps_events=+f.properties.trips_camps_events}});map_init()})};const map_init=()=>{mapboxgl.accessToken=MAPBOX_ACCESS_TOKEN;var map=new mapboxgl.Map({container:"map",style:MAPBOX_STYLE_URL_V2,center:[-79.319,43.813],zoom:9.902,pitch:56.014,bearing:-18.22});map.scrollZoom.disable();if(/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)){map.dragPan.disable();map.touchPitch.disable();map.on("touchstart",function(e){var oe=e.originalEvent;if(oe&&"touches"in oe){if(oe.touches.length>1){oe.stopImmediatePropagation();map.dragPan.enable()}else{map.dragPan.disable()}}})}map.on("load",function(){var layers=map.getStyle().layers;var firstSymbolId;for(var i=0;i<layers.length;i++){if(layers[i].id.search("label")!=-1){firstSymbolId=layers[i].id;console.log(firstSymbolId);break}}map.addSource("gta_data",{type:"geojson",data:gta});map.addSource("areas_data",{type:"geojson",data:areas});map.addLayer({id:"areas",type:"fill",source:"areas_data",layout:{},paint:{"fill-color":["get","fill"],"fill-opacity":["get","opacity"],"fill-outline-color":["get","outline"]}},"road-label");map.addLayer({id:"gta_outline",type:"line",source:"gta_data",layout:{"line-miter-limit":.5},paint:{"line-color":"#04aeff","line-opacity":1,"line-width":["interpolate",["linear"],["zoom"],5,5,15,20]}},"areas");map.on("click",click);map.on("mouseenter","areas",function(){map.getCanvas().style.cursor="pointer"});map.on("mouseleave","areas",function(){map.getCanvas().style.cursor=""});map.on("move",function(e){})});function renderInfo(features){let top_feature=features[0];let props=top_feature.properties;let critical=props.critical?`<p>${props.critical} Critical</p>`:"";let community=props.community?`<p>• ${props.community} Community Outreach</p>`:"";let marketplace=props.marketplace?`<p>• ${props.marketplace} Marketplace Initiative</p>`:"";let leadership=props.leadership_development?`<p>• ${props.leadership_development} Leadership Development</p>`:"";let specialized=props.specialized?`<p>• ${props.specialized} Specialized Initiatives</p>`:"";let trips=props.trips?`<p>• ${props.trips} Trips</p>`:"";let teams=props.teams?`<p>${props.teams.replace(/<.*>/g,"-")}</p>`:"";let out=`\n    <div class="info" style="background-color:${props.fill};">\n      <h2>${props.catchment}</h2>\n      <h3>Active Initiatives</h3>\n      ${community}\n      ${marketplace}\n      ${leadership}\n      ${specialized}\n      <h3>Active Teams</h3>\n      ${teams}\n    </div>\n    `;return out}function click(e){let p=e.point;let fs=map.queryRenderedFeatures(p).filter(f=>f.properties.catchment!==undefined);if(fs.length===0){d3.select("#popup").classed("hidden",true);return}fs.forEach(d=>console.log(d.properties.id));console.log("====");let top=fs[0];let props=top.properties;props=Object.assign({critical_care:0,community_outreach:0,innovative_centres:0,leadership_development:0,marketplace:0,trips_camps_events:0},props);let agg_level=props.aggregation_level;let peers=fs.filter((f,i)=>i>0&&f.properties.aggregation_level==agg_level);console.log(peers.length);peers.forEach(p=>{["critical_care","community_outreach","innovative_centres","leadership_development","marketplace","trips_camps_events"].forEach(factor=>props[factor]+=p.properties[factor])});let div=d3.select("#popup").datum(props).call(renderPopup).classed("hidden",false)}function renderPopup(sel){if(!sel.select(".info").empty())sel.select(".catchment").remove();let d=sel.datum();let critical=d.critical_care?`<p>• Critical Care: ${d.critical_care}</p>`:"";let community=d.community_outreach?`<p>• Community Outreach: ${d.community_outreach}</p>`:"";let innovation=d.innovative_centres?`<p>• Innovative Centres: ${d.innovative_centres}</p>`:"";let leadership=d.leadership_development?`<p>• Leadership Development: ${d.leadership_development}</p>`:"";let marketplace=d.marketplace?`<p>• Marketplace: ${d.marketplace}</p>`:"";let trips=d.trips_camps_events?`<p>• Trips, Camps and Events: ${d.trips_camps_events}</p>`:"";let teams=d.team_ids.split(",").map(renderTeamLink).join(", ");sel.html(`\n        <div class="info" style="background-color:${d.fill};">\n          <div id="close">close</div>\n          <h2>${d.catchment}</h2>\n          <h3>Active Initiatives</h3>\n          ${critical}\n          ${community}\n          ${innovation}\n          ${leadership}\n          ${marketplace}\n          ${trips}\n          <h3>Active Teams</h3>\n          ${teams}\n        </div>\n      `).select("#close").on("click",closePopup)}function renderTeamLink(tid){let t=teams.find(d=>d.id==tid);return`<a target="_PARENT" href="${BASE_URL}${t.url}">${t.name}</a>`}function closePopup(){d3.select("#popup").classed("hidden",true)}map.addControl(new mapboxgl.NavigationControl)};setTimeout(init,500);
